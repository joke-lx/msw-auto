# 总体架构方案

## 一、系统概述

### 1.1 项目愿景

打造一个**零侵入、全自动化、AI 驱动**的 Mock 服务器解决方案，彻底改变前端开发体验。

### 1.2 核心价值主张

| 特性         | 传统 MSW                 | 智能自动化 Mock        |
| ------------ | ------------------------ | ---------------------- |
| 前端代码侵入 | 需要导入和配置           | **完全零侵入**         |
| Mock 创建    | 手工编写                 | **AI 自动生成**        |
| 代理能力     | 需要手动配置 passthrough | **智能自动代理**       |
| 文档生成     | 手工维护                 | **自动生成 MD 文档**   |
| 调试体验     | 控制台日志               | **可视化 Web UI**      |
| 协作能力     | 单机使用                 | **多人协作 + AI 助手** |

### 1.3 目标用户

- **前端开发者**：无需后端即可独立开发
- **测试工程师**：快速创建测试场景
- **产品经理**：通过 UI 理解 API 行为
- **后端开发者**：在 API 开发前提供接口规范

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  前端应用 A  │  │  前端应用 B  │  │  前端应用 C  │  │   移动应用   │ │
│  │ (React)      │  │  (Vue)       │  │  (Angular)   │  │  (iOS/Android)│ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
└─────────┼──────────────────┼──────────────────┼──────────────────┼─────────┘
          │                  │                  │                  │
          │                  │                  │                  │
          └──────────────────┼──────────────────┼──────────────────┘
                             │                  │
                             │ HTTP/GraphQL/WebSocket
                             ↓
        ┌────────────────────────────────────────────────────────┐
        │              智能自动化 Mock 服务器                   │
        │                                                      │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │              代理网关层                        │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │HTTP 代理 │  │GraphQL  │  │WebSocket│  │  │
        │  │  │          │  │  代理    │  │   代理   │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                         ↓                              │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │              请求处理层                        │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │请求拦截  │  │路由匹配  │  │Mock匹配  │  │  │
        │  │  │          │  │          │  │          │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                         ↓                              │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │             Mock 管理层                         │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │Mock 存储 │  │Mock 管理 │  │版本控制  │  │  │
        │  │  │          │  │          │  │          │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                         ↓                              │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │             AI 生成层                           │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │Claude    │  │提示词    │  │代码生成  │  │  │
        │  │  │集成      │  │工程      │  │          │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                         ↓                              │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │             数据持久层                         │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │SQLite    │  │Redis    │  │文件存储  │  │  │
        │  │  │          │  │缓存     │  │          │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                                                      │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │              Web UI 服务                       │  │
        │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
        │  │  │API面板   │  │Claude    │  │文档生成  │  │  │
        │  │  │          │  │侧边栏    │  │          │  │  │
        │  │  └──────────┘  └──────────┘  └──────────┘  │  │
        │  └──────────────────────────────────────────────────┘  │
        │                                                      │
        └──────────────────┬───────────────────────────────────────┘
                           │
                           │
                           ├─────────────┐
                           │             │
                           ↓             ↓
        ┌────────────────────────┐  ┌────────────────────────┐
        │    真实后端服务器       │  │   外部 LLM 服务       │
        │  (当无匹配 Mock 时)     │  │   (Claude API)        │
        └────────────────────────┘  └────────────────────────┘
```

### 2.2 分层架构

#### 2.2.1 表现层（Presentation Layer）

```
Web UI (React + TypeScript)
├── Dashboard              # 仪表盘
├── API Explorer          # API 浏览器
├── Mock Editor          # Mock 编辑器
├── Claude Assistant      # AI 助手
├── Documentation        # 文档生成器
└── Settings            # 设置
```

#### 2.2.2 应用层（Application Layer）

```
应用服务
├── MockService         # Mock 服务
├── ProxyService       # 代理服务
├── LLMService         # LLM 服务
├── DocService         # 文档服务
└── LogService         # 日志服务
```

#### 2.2.3 业务逻辑层（Business Layer）

```
业务逻辑
├── MockManager        # Mock 管理器
├── RequestMatcher    # 请求匹配器
├── ResponseBuilder   # 响应构建器
├── MockGenerator    # Mock 生成器
└── VersionControl   # 版本控制
```

#### 2.2.4 数据访问层（Data Access Layer）

```
数据访问
├── MockRepository     # Mock 仓储
├── RequestRepository # 请求仓储
├── CacheRepository   # 缓存仓储
└── FileRepository   # 文件仓储
```

#### 2.2.5 基础设施层（Infrastructure Layer）

```
基础设施
├── Database          # 数据库
├── Cache             # 缓存
├── FileSystem        # 文件系统
├── WebSocket        # WebSocket
├── HTTPClient       # HTTP 客户端
└── Logger           # 日志
```

---

## 三、核心模块设计

### 3.1 代理网关模块

#### 3.1.1 职责

- 拦截所有来自前端的请求
- 根据配置路由到 Mock 或真实后端
- 支持多种协议：HTTP、HTTPS、WebSocket、GraphQL
- 记录请求和响应日志

#### 3.1.2 架构

```typescript
class ProxyGateway {
  private httpProxy: HttpProxy
  private graphqlProxy: GraphQLProxy
  private websocketProxy: WebSocketProxy
  private requestLogger: RequestLogger

  async handleRequest(req: Request): Promise<Response> {
    // 1. 记录请求
    this.requestLogger.log(req)

    // 2. 检查是否有匹配的 Mock
    const mock = await this.mockManager.findMatchingMock(req)

    if (mock) {
      // 3. 返回 Mock 响应
      return this.mockManager.executeMock(mock, req)
    }

    // 4. 代理到真实后端
    return this.proxyToBackend(req)
  }
}
```

### 3.2 Mock 管理模块

#### 3.2.1 职责

- 管理 Mock 数据的 CRUD
- 匹配请求到对应的 Mock
- 支持 Mock 的启用/禁用
- 版本管理和历史记录

#### 3.2.2 架构

```typescript
class MockManager {
  private repository: MockRepository
  private cache: CacheRepository

  async findMatchingMock(req: Request): Promise<Mock | null> {
    // 1. 尝试从缓存获取
    const cached = await this.cache.get(req)
    if (cached) return cached

    // 2. 从数据库查询
    const mocks = await this.repository.findAll()

    // 3. 匹配规则
    for (const mock of mocks) {
      if (this.matches(req, mock)) {
        await this.cache.set(req, mock)
        return mock
      }
    }

    return null
  }

  matches(req: Request, mock: Mock): boolean {
    return (
      this.matchMethod(req, mock) &&
      this.matchPath(req, mock) &&
      this.matchQuery(req, mock) &&
      this.matchHeaders(req, mock) &&
      this.matchBody(req, mock)
    )
  }
}
```

### 3.3 AI 生成模块

#### 3.3.1 职责

- 与 Claude API 集成
- 根据请求自动生成 Mock 数据
- 支持自然语言修改 Mock
- 生成 API 文档

#### 3.3.2 架构

```typescript
class LLMService {
  private claudeClient: ClaudeClient
  private promptBuilder: PromptBuilder
  private responseParser: ResponseParser

  async generateMock(request: Request): Promise<Mock> {
    // 1. 构建提示词
    const prompt = this.promptBuilder.buildPrompt(request)

    // 2. 调用 Claude API
    const response = await this.claudeClient.completions(prompt)

    // 3. 解析响应
    const mock = this.responseParser.parseMock(response)

    // 4. 保存 Mock
    return await this.mockManager.create(mock)
  }

  async improveMock(mock: Mock, instruction: string): Promise<Mock> {
    // 1. 构建改进提示词
    const prompt = this.promptBuilder.buildImprovePrompt(mock, instruction)

    // 2. 调用 Claude API
    const response = await this.claudeClient.completions(prompt)

    // 3. 解析并更新 Mock
    const improvedMock = this.responseParser.parseMock(response)
    return await this.mockManager.update(mock.id, improvedMock)
  }
}
```

### 3.4 Web UI 模块

#### 3.4.1 职责

- 提供可视化界面
- 实时显示请求和响应
- 提供 Mock 编辑功能
- 集成 Claude AI 助手
- 生成和导出文档

#### 3.4.2 架构

```typescript
// 主应用
class WebUI {
  private dashboard: Dashboard
  private apiPanel: APIPanel
  private claudeSidebar: ClaudeSidebar
  private documentGenerator: DocumentGenerator

  render() {
    return (
      <Layout>
        <Dashboard />
        <MainContent>
          <RequestList />
          <APIPanel />
        </MainContent>
        <Sidebar>
          <ClaudeSidebar />
        </Sidebar>
      </Layout>
    )
  }
}
```

---

## 四、数据流设计

### 4.1 请求处理流程

```
前端应用
    │
    │ HTTP 请求
    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. 请求拦截                                          │
│    - 记录请求信息                                      │
│    - 提取元数据（method, url, headers, body）          │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 2. Mock 匹配                                         │
│    - 查询数据库                                      │
│    - 匹配规则（method, path, query, headers, body）   │
│    - 返回匹配的 Mock 或 null                         │
└────────────────┬────────────────────────────────────────┘
                 │
        ┌────────┴────────┐
        │                 │
        ↓                 ↓
    匹配 Mock        未匹配
        │                 │
        ↓                 ↓
┌──────────────────┐  ┌──────────────────┐
│ 3. 执行 Mock    │  │ 4. 代理到后端   │
│    - 生成响应    │  │    - 转发请求   │
│    - 应用延迟    │  │    - 记录响应   │
│    - 设置响应头  │  │    - 返回响应   │
└────────┬─────────┘  └────────┬─────────┘
         │                    │
         └────────┬───────────┘
                  │
                  ↓
         ┌────────────────┐
         │ 5. 返回响应    │
         │    - 发送到前端 │
         │    - 记录日志  │
         └────────────────┘
```

### 4.2 AI 生成流程

```
用户操作
    │
    │ 点击"生成 Mock" 或输入自然语言指令
    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. 收集上下文                                        │
│    - 当前请求信息                                      │
│    - 现有 Mock 数据                                    │
│    - 历史对话记录                                      │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 构建提示词                                        │
│    - 系统提示词（角色设定）                           │
│    - 上下文信息                                        │
│    - 用户指令                                          │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 调用 Claude API                                   │
│    - 发送请求到 Anthropic API                         │
│    - 接收响应流                                        │
│    - 处理超时和错误                                    │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 4. 解析响应                                          │
│    - 提取 JSON 数据                                   │
│    - 验证数据格式                                      │
│    - 错误处理                                          │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 5. 保存 Mock                                         │
│    - 生成唯一 ID                                       │
│    - 保存到数据库                                      │
│    - 更新缓存                                          │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│ 6. 更新 UI                                           │
│    - 通过 WebSocket 推送更新                           │
│    - 刷新 Mock 列表                                   │
│    - 显示成功消息                                      │
└─────────────────────────────────────────────────────────┘
```

---

## 五、技术选型

### 5.1 后端技术栈

| 技术       | 版本   | 用途         |
| ---------- | ------ | ------------ |
| Node.js    | >= 18  | 运行时       |
| TypeScript | >= 5.0 | 类型安全     |
| Express    | 4.18   | Web 框架     |
| http-proxy | 1.18   | HTTP 代理    |
| WebSocket  | 8.13   | 实时通信     |
| SQLite3    | 5.1    | 数据库       |
| Redis      | 7.0    | 缓存（可选） |
| Winston    | 3.11   | 日志         |
| Jest       | 29.7   | 测试         |

### 5.2 前端技术栈

| 技术             | 版本 | 用途             |
| ---------------- | ---- | ---------------- |
| React            | 18.2 | UI 框架          |
| TypeScript       | 5.0  | 类型安全         |
| Vite             | 5.0  | 构建工具         |
| Ant Design       | 5.12 | UI 组件库        |
| React Router     | 6.20 | 路由             |
| Axios            | 1.6  | HTTP 客户端      |
| Socket.io-client | 4.6  | WebSocket 客户端 |
| Monaco Editor    | 0.45 | 代码编辑器       |

### 5.3 AI 集成

| 技术              | 版本 | 用途                 |
| ----------------- | ---- | -------------------- |
| @anthropic-ai/sdk | 0.24 | Claude API 客户端    |
| OpenAI API        | -    | 备用 LLM             |
| LangChain         | -    | LLM 应用框架（可选） |

### 5.4 开发工具

| 技术       | 版本 | 用途       |
| ---------- | ---- | ---------- |
| ESLint     | 8.56 | 代码检查   |
| Prettier   | 3.1  | 代码格式化 |
| Husky      | 8.0  | Git hooks  |
| Commitlint | 18.6 | 提交规范   |
| Nodemon    | 3.0  | 热重载     |

---

## 六、部署架构

### 6.1 开发环境

```
开发者机器
├── 前端应用 (localhost:3000)
├── Mock 服务器 (localhost:4000)
└── Web UI (localhost:4001)
```

### 6.2 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                      负载均衡器                          │
│                   (Nginx / ALB)                           │
└──────────────────┬────────────────────────────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ↓          ↓          ↓
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Mock 实例 1 │ │ Mock 实例 2 │ │ Mock 实例 N │
│ (端口 4000) │ │ (端口 4000) │ │ (端口 4000) │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        └─────────────┼─────────────┘
                      │
                      ↓
              ┌───────────────┐
              │ 共享数据库     │
              │   (PostgreSQL)│
              └───────────────┘
```

### 6.3 容器化部署

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci --only=production

# 复制代码
COPY . .

# 构建前端
RUN npm run build

# 暴露端口
EXPOSE 4000 4001

# 启动服务
CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  mock-server:
    build: .
    ports:
      - '4000:4000'
      - '4001:4001'
    environment:
      - NODE_ENV=production
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - DATABASE_URL=postgresql://user:pass@db:5432/mocks
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=mocks
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'

volumes:
  db_data:
```

---

## 七、安全设计

### 7.1 认证和授权

```
┌─────────────────────────────────────────────────────────┐
│ 认证流程                                              │
│                                                       │
│ 1. 用户登录                                            │
│    - 支持 JWT Token                                    │
│    - 支持 OAuth 2.0 (GitHub, Google)                  │
│                                                       │
│ 2. Token 验证                                         │
│    - 中间件验证 Token                                  │
│    - 支持 Token 刷新                                    │
│                                                       │
│ 3. 权限控制                                           │
│    - 基于角色的访问控制 (RBAC)                          │
│    - Mock 级别的权限                                    │
│    - 操作审计日志                                        │
└─────────────────────────────────────────────────────────┘
```

### 7.2 数据安全

- **敏感数据加密**：API Key、密码等使用加密存储
- **HTTPS**：强制使用 HTTPS 传输
- **输入验证**：所有输入数据进行验证和清理
- **SQL 注入防护**：使用参数化查询
- **XSS 防护**：输出数据进行转义

### 7.3 API 安全

- **速率限制**：防止 API 滥用
- **CORS 配置**：限制跨域访问
- **请求签名**：验证请求来源
- **IP 白名单**：限制访问来源

---

## 八、监控和运维

### 8.1 监控指标

```
┌─────────────────────────────────────────────────────────┐
│ 系统监控                                              │
│                                                       │
│ 1. 服务状态                                            │
│    - CPU 使用率                                        │
│    - 内存使用率                                        │
│    - 磁盘使用率                                        │
│                                                       │
│ 2. 业务指标                                            │
│    - 请求总数                                          │
│    - Mock 命中率                                       │
│    - 响应时间                                          │
│    - 错误率                                            │
│                                                       │
│ 3. Claude API                                          │
│    - 调用次数                                          │
│    - Token 使用量                                      │
│    - 成本统计                                          │
│    - 错误率                                            │
└─────────────────────────────────────────────────────────┘
```

### 8.2 日志系统

```
日志分类
├── 访问日志 (access.log)
│   - 请求时间、方法、URL、状态码
│
├── 错误日志 (error.log)
│   - 系统错误、异常堆栈
│
├── Mock 日志 (mock.log)
│   - Mock 使用情况、版本变化
│
└── 审计日志 (audit.log)
    - 用户操作、权限变更
```

### 8.3 告警策略

- **服务异常**：5 分钟内超过 5% 错误率
- **性能降级**：平均响应时间 > 1 秒
- **Claude API 异常**：连续失败 3 次
- **磁盘空间**：使用率 > 80%

---

## 九、扩展性设计

### 9.1 水平扩展

- 无状态设计，支持多实例部署
- 数据库支持读写分离
- 缓存层支持分布式

### 9.2 插件系统

```typescript
interface Plugin {
  name: string
  version: string
  install(server: MockServer): void
  uninstall(server: MockServer): void
}

// 示例插件
class AnalyticsPlugin implements Plugin {
  name = 'analytics'
  version = '1.0.0'

  install(server: MockServer) {
    server.on('request', (req) => {
      this.trackRequest(req)
    })
  }

  uninstall(server: MockServer) {
    server.off('request', this.trackRequest)
  }
}
```

### 9.3 自定义适配器

```typescript
interface MockAdapter {
  matches(request: Request): boolean
  generate(request: Request): Promise<Mock>
}

// 用户可以实现自己的 Mock 生成策略
class CustomAdapter implements MockAdapter {
  matches(request: Request): boolean {
    return request.url.startsWith('/custom/')
  }

  async generate(request: Request): Promise<Mock> {
    // 自定义 Mock 生成逻辑
  }
}
```

---

## 十、项目里程碑

### Phase 1: 基础功能（4 周）

- ✅ 代理网关实现
- ✅ 基础 Mock 管理
- ✅ 简单的 Web UI
- ✅ 请求日志记录

### Phase 2: AI 集成（3 周）

- ✅ Claude API 集成
- ✅ 自动 Mock 生成
- ✅ 自然语言交互
- ✅ 文档自动生成

### Phase 3: 高级功能（4 周）

- ✅ 版本控制
- ✅ 多用户协作
- ✅ 权限管理
- ✅ 性能优化

### Phase 4: 生产就绪（3 周）

- ✅ 安全加固
- ✅ 监控告警
- ✅ 文档完善
- ✅ 测试覆盖

---

## 十一、总结

这个架构方案提供了：

✅ **零侵入性**：完全独立于前端代码
✅ **智能化**：AI 驱动的自动 Mock 生成
✅ **可视化**：强大的 Web UI 界面
✅ **可扩展**：插件系统和自定义适配器
✅ **生产就绪**：完整的监控、日志、安全方案

这是一个面向未来的 Mock 解决方案，可以彻底改变前端开发体验！
